apiVersion: batch/v1
kind: Job
metadata:
  name: sqlserver-init-custom
  namespace: consolide
spec:
  backoffLimit: 3
  template:
    spec:
      restartPolicy: OnFailure
      containers:
        - name: sqlserver-init
          image: mcr.microsoft.com/mssql/server:2022-latest
          env:
            - name: SA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: sqlserver-secret
                  key: SA_PASSWORD
          command: ["/bin/bash", "-c"]
          args:
            - |
              echo "üöÄ Attente que SQL Server soit accessible..."
              
              # Attendre que SQL Server soit pr√™t
              for i in {1..30}; do
                if /opt/mssql-tools18/bin/sqlcmd -S sqlserver.consolide.svc.cluster.local,1433 -U sa -P "$SA_PASSWORD" -Q "SELECT 1" -C >/dev/null 2>&1; then
                  echo "‚úÖ SQL Server accessible!"
                  break
                fi
                echo "Tentative $i/30... (attente 15s)"
                sleep 15
              done

              # V√©rification finale
              if ! /opt/mssql-tools18/bin/sqlcmd -S sqlserver.consolide.svc.cluster.local,1433 -U sa -P "$SA_PASSWORD" -Q "SELECT 1" -C >/dev/null 2>&1; then
                echo "‚ùå Impossible de se connecter √† SQL Server"
                exit 1
              fi

              echo "üìä Ex√©cution du script ConsolideUsersDB..."
              
              # Ex√©cuter le script ConsolideUsersDB
              if /opt/mssql-tools18/bin/sqlcmd -S sqlserver.consolide.svc.cluster.local,1433 -U sa -P "$SA_PASSWORD" -i /scripts/01-init-ConsolideUsersDB.sql -C; then
                echo "‚úÖ Script ConsolideUsersDB ex√©cut√© avec succ√®s"
              else
                echo "‚ùå Erreur lors de l'ex√©cution du script ConsolideUsersDB"
                # Ne pas arr√™ter, continuer avec le suivant
              fi

              echo "üìä Ex√©cution du script ConsolideDB..."
              
              # Ex√©cuter le script ConsolideDB
              if /opt/mssql-tools18/bin/sqlcmd -S sqlserver.consolide.svc.cluster.local,1433 -U sa -P "$SA_PASSWORD" -i /scripts/02-init-ConsolideDB.sql -C; then
                echo "‚úÖ Script ConsolideDB ex√©cut√© avec succ√®s"
              else
                echo "‚ùå Erreur lors de l'ex√©cution du script ConsolideDB"
              fi

              echo "‚úÖ Initialisation termin√©e!"
              
              # V√©rification finale
              echo "üîç V√©rification des bases cr√©√©es:"
              /opt/mssql-tools18/bin/sqlcmd -S sqlserver.consolide.svc.cluster.local,1433 -U sa -P "$SA_PASSWORD" -C -Q "SELECT name FROM sys.databases WHERE name IN ('ConsolideUsersDB', 'ConsolideDB')"
              
              # V√©rifier les tables dans ConsolideUsersDB
              echo "üîç Tables dans ConsolideUsersDB:"
              /opt/mssql-tools18/bin/sqlcmd -S sqlserver.consolide.svc.cluster.local,1433 -U sa -P "$SA_PASSWORD" -d ConsolideUsersDB -C -Q "SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE'"
              
              # V√©rifier les tables dans ConsolideDB
              echo "üîç Tables dans ConsolideDB:"
              /opt/mssql-tools18/bin/sqlcmd -S sqlserver.consolide.svc.cluster.local,1433 -U sa -P "$SA_PASSWORD" -d ConsolideDB -C -Q "SELECT TABLE_NAME FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_TYPE = 'BASE TABLE'"

          volumeMounts:
            - name: sql-scripts
              mountPath: /scripts
      volumes:
        - name: sql-scripts
          configMap:
            name: sqlserver-scripts
